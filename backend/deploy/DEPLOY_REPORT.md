# –û—Ç—á—ë—Ç –æ –¥–µ–ø–ª–æ–µ ShortsAI Backend –≤ Google Cloud Run

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### 1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ prompt-6a4fd

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω**

```bash
gcloud projects undelete prompt-6a4fd
# –†–µ–∑—É–ª—å—Ç–∞—Ç: Project restored successfully
# Lifecycle State: ACTIVE
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–ª–ª–∏–Ω–≥–∞

**–°—Ç–∞—Ç—É—Å**: ‚ö†Ô∏è **–¢–†–ï–ë–£–ï–¢–°–Ø –†–£–ß–ù–û–ï –î–ï–ô–°–¢–í–ò–ï**

–ë–∏–ª–ª–∏–Ω–≥ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –ø—Ä–æ–µ–∫—Ç—É. –î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –¥–µ–ø–ª–æ—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å billing account.

**–î–æ—Å—Ç—É–ø–Ω—ã–µ billing accounts:**
- `0125D6-E212DE-FD3C74` - Firebase Payment
- `017037-B928A3-B0D9C4` - My Billing Account 1
- `019621-B7AACB-661ABA` - Firebase Payment
- `01A5EA-A02C07-73A08B` - Firebase Payment
- `01DD6A-876501-FF1C94` - My Billing Account
- `01FEFF-7A36CE-1B0D7D` - Firebase Payment

**–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏:**
```bash
gcloud billing projects link prompt-6a4fd --billing-account=01DD6A-876501-FF1C94
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ Firebase/Firestore

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–ê–∫—Ç–∏–≤–Ω–∞**

Firestore –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∞–∫—Ç–∏–≤–Ω–∞:
- **Database ID**: `(default)`
- **Location**: `nam5` (us-central)
- **Edition**: `STANDARD`
- **Type**: `FIRESTORE_NATIVE`
- **Create Time**: `2025-11-28T07:47:08.636781Z`

**–í–∞–∂–Ω–æ**: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞, –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞.

### 4. –°–æ–∑–¥–∞–Ω–∏–µ Worker —Å–∫—Ä–∏–ø—Ç–∞

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–°–æ–∑–¥–∞–Ω**

–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `backend/src/worker.ts` –∫–æ—Ç–æ—Ä—ã–π:
- –í—ã–ø–æ–ª–Ω—è–µ—Ç –æ–¥–∏–Ω —Ü–∏–∫–ª –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç distributed lock –≤ Firestore –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤
- –í—ã–∑—ã–≤–∞–µ—Ç `processAutoSendTick()` –∏ `processBlottataTick()`
- –ó–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è Cloud Run Job)

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Lock —Å TTL 5 –º–∏–Ω—É—Ç
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ lock –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤
- Exit code 0 –ø—Ä–∏ —É—Å–ø–µ—Ö–µ, 1 –ø—Ä–∏ –æ—à–∏–±–∫–µ

### 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ package.json

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–û–±–Ω–æ–≤–ª—ë–Ω**

–î–æ–±–∞–≤–ª–µ–Ω —Å–∫—Ä–∏–ø—Ç `worker`:
```json
"worker": "node dist/worker.js"
```

### 6. Dockerfile

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–°—É—â–µ—Å—Ç–≤—É–µ—Ç**

Dockerfile —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ `backend/Dockerfile` –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.

### 7. –°–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–°–æ–∑–¥–∞–Ω**

–°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `backend/deploy/deploy_cloud_run.sh` –∫–æ—Ç–æ—Ä—ã–π:
- –í–∫–ª—é—á–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ API
- –°–æ–∑–¥–∞—ë—Ç Artifact Registry —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
- –°–æ–±–∏—Ä–∞–µ—Ç –∏ –ø—É—à–∏—Ç Docker –æ–±—Ä–∞–∑
- –î–µ–ø–ª–æ–∏—Ç Cloud Run Service (API)
- –î–µ–ø–ª–æ–∏—Ç Cloud Run Job (Worker)
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç Cloud Scheduler

### 8. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–°–æ–∑–¥–∞–Ω–∞**

–°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ `backend/deploy/DEPLOY_CLOUD_RUN.md`:
- –ü–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è
- Troubleshooting
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ

## ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å

### 1. –ü—Ä–∏–≤—è–∑–∞—Ç—å –±–∏–ª–ª–∏–Ω–≥ (–ö–†–ò–¢–ò–ß–ù–û!)

```bash
gcloud billing projects link prompt-6a4fd --billing-account=01DD6A-876501-FF1C94
```

### 2. –í–∫–ª—é—á–∏—Ç—å API

–ü–æ—Å–ª–µ –ø—Ä–∏–≤—è–∑–∫–∏ –±–∏–ª–ª–∏–Ω–≥–∞:

```bash
gcloud services enable \
  run.googleapis.com \
  artifactregistry.googleapis.com \
  cloudbuild.googleapis.com \
  cloudscheduler.googleapis.com \
  secretmanager.googleapis.com \
  storage.googleapis.com \
  firestore.googleapis.com \
  --project=prompt-6a4fd
```

### 3. –°–æ–∑–¥–∞—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –≤ Secret Manager

–°–º. —Ä–∞–∑–¥–µ–ª "–®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Secret Manager" –≤ `DEPLOY_CLOUD_RUN.md`

### 4. –í—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–ø–ª–æ–π

**–í–∞—Ä–∏–∞–Ω—Ç A: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π (—á–µ—Ä–µ–∑ Git Bash –∏–ª–∏ WSL)**
```bash
cd backend
bash deploy/deploy_cloud_run.sh
```

**–í–∞—Ä–∏–∞–Ω—Ç B: –†—É—á–Ω–æ–π**
–°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –≤ `DEPLOY_CLOUD_RUN.md`, —Ä–∞–∑–¥–µ–ª "–®–∞–≥ 4: –î–µ–ø–ª–æ–π"

## üìã –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### Cloud Run Service (API)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: HTTP API –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
- **–ü–æ—Ä—Ç**: 8080
- **Health endpoint**: `/health`
- **Cron scheduler**: –û—Ç–∫–ª—é—á–µ–Ω (`ENABLE_CRON_SCHEDULER=false`)
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ**: 0-10 –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤

### Cloud Run Job (Worker)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ (–æ–¥–∏–Ω —Ü–∏–∫–ª)
- **–ö–æ–º–∞–Ω–¥–∞**: `npm run worker`
- **Lock**: Distributed lock –≤ Firestore
- **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ**: –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (exit 0/1)

### Cloud Scheduler
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ó–∞–ø—É—Å–∫ Job –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- **Schedule**: `* * * * *` (–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É)
- **Service Account**: `shortsai-scheduler@prompt-6a4fd.iam.gserviceaccount.com`

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **–°–µ–∫—Ä–µ—Ç—ã**: –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ Secret Manager
2. **IAM**: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–ª—è service accounts
3. **Lock**: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤
4. **Health check**: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ Service
```bash
gcloud run services logs read shortsai-backend \
  --region us-central1 \
  --project prompt-6a4fd \
  --limit 50
```

### –õ–æ–≥–∏ Job
```bash
gcloud run jobs executions logs read \
  --job shortsai-worker \
  --region us-central1 \
  --project prompt-6a4fd \
  --limit 50
```

### Health Check
```bash
SERVICE_URL=$(gcloud run services describe shortsai-backend \
  --platform managed \
  --region us-central1 \
  --project prompt-6a4fd \
  --format="value(status.url)")

curl $SERVICE_URL/health
```

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ü—Ä–∏–≤—è–∑–∞—Ç—å –±–∏–ª–ª–∏–Ω–≥** (—Å–º. –≤—ã—à–µ)
2. **–í–∫–ª—é—á–∏—Ç—å API** (—Å–º. –≤—ã—à–µ)
3. **–°–æ–∑–¥–∞—Ç—å —Å–µ–∫—Ä–µ—Ç—ã** –≤ Secret Manager
4. **–í—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–ø–ª–æ–π** —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç –∏–ª–∏ –≤—Ä—É—á–Ω—É—é
5. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É** —á–µ—Ä–µ–∑ health check –∏ –ª–æ–≥–∏

## üìù –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ë–∏–ª–ª–∏–Ω–≥ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω** - –±–µ–∑ –Ω–µ–≥–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å API –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–ø–ª–æ–π
2. **Firestore –∞–∫—Ç–∏–≤–Ω–∞** - –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã
3. **Worker –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–µ—á–Ω—ã–π —Ü–∏–∫–ª** - –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è
4. **Scheduler –∑–∞–ø—É—Å–∫–∞–µ—Ç Job –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É** - —ç—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ä–µ–≥—É–ª—è—Ä–Ω—É—é —Ä–∞–±–æ—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
5. **Lock –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—É—Å–∫–∏** - –µ—Å–ª–∏ Job –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è > 1 –º–∏–Ω—É—Ç—ã, —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—Å—è

## üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: `backend/deploy/DEPLOY_CLOUD_RUN.md`
- **–°–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è**: `backend/deploy/deploy_cloud_run.sh`
- **Worker –∫–æ–¥**: `backend/src/worker.ts`
- **GCP Console**: https://console.cloud.google.com/
- **Firebase Console**: https://console.firebase.google.com/

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

| –ó–∞–¥–∞—á–∞ | –°—Ç–∞—Ç—É—Å |
|--------|--------|
| –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ | ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–ª–ª–∏–Ω–≥–∞ | ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–≤—è–∑–∫–∞ |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ Firebase | ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞ |
| –°–æ–∑–¥–∞–Ω–∏–µ Worker | ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ |
| –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–µ–ø–ª–æ—è | ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ |
| –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è | ‚úÖ –°–æ–∑–¥–∞–Ω–∞ |
| **–î–µ–ø–ª–æ–π** | ‚è∏Ô∏è **–û–∂–∏–¥–∞–µ—Ç –±–∏–ª–ª–∏–Ω–≥** |

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á—ë—Ç–∞**: 2025-01-27
**–ü—Ä–æ–µ–∫—Ç**: prompt-6a4fd
**–°—Ç–∞—Ç—É—Å**: –ì–æ—Ç–æ–≤ –∫ –¥–µ–ø–ª–æ—é –ø–æ—Å–ª–µ –ø—Ä–∏–≤—è–∑–∫–∏ –±–∏–ª–ª–∏–Ω–≥–∞

